name: Run DB Migrations on VPS

on:
  workflow_dispatch:

jobs:
  test-db-migrations:
    name: Run Migration on VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.VPS_SSH_KEY }}" | base64 --decode > key.pem
          chmod 600 key.pem

      - name: Run Migration via SSH on VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'EOF'
            echo "ðŸ“¥ Pulling latest code..."
            ${{ secrets.VPS_DEPLOY_PATH }}
            cd
            git pull origin main

            echo "ðŸ³ Restarting containers..."
            docker-compose down
            docker-compose up -d smartpay-postgres
            sleep 5
            docker-compose up -d smartpay-api

            echo "ðŸ“¦ Running migrations..."
            docker-compose exec smartpay-api sh -c "python manage.py migrate_all"
          EOF

      - name: Notify Telegram - Migration Success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âœ… *SmartPay Migration Succeeded*\nRepo: \`${{ github.repository }}\`\nðŸ”— [View Run]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" \
            -d parse_mode=Markdown

      - name: Notify Telegram - Migration Failed
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âŒ *SmartPay Migration Failed*\nRepo: \`${{ github.repository }}\`\nðŸ”— [View Run]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" \
            -d parse_mode=Markdown
